#!/bin/bash

if [ "$1" == "download" ]; then
   if [[ -z $(ls | grep "Squeak[^\.]*\.sources") ]]; then
      echo "Downloading current trunk image"
      TRUNK="ftp://ftp.squeak.org/trunk/"
      SOURCES="ftp://ftp.squeak.org/sources_files/"
      SQUEAK_IMAGE_FILES=$(curl ${TRUNK} | grep "Squeak.*zip" | tail -1 | awk '{print $NF}')
      SQUEAK_SOURCES_FILE=$(curl ${SOURCES} | grep "sources.gz" | tail -1 | awk '{print $NF}')
      wget "${SOURCES}${SQUEAK_SOURCES_FILE}"
      wget "${TRUNK}${SQUEAK_IMAGE_FILES}"
      unzip Squeak*zip
      gunzip Squeak*sources.gz
      rm Squeak*zip
      if [[ -z $(ls | grep Squeak.*image) ]]; then
         possible_squeak_dir="$(ls --group-directories-first | grep -m1 Squeak)"
         if [[ -d $possible_squeak_dir ]]; then
            mv "$possible_squeak_dir"/* .
            rmdir "$possible_squeak_dir"
         fi
      fi
   fi
else
   BIN=`/usr/bin/dirname "$0"`/lib/squeak/3.9-7
   IMAGE="$1"

   # At least on linux LD_LIBRARY_PATH's components must be absolute path names
   case "$BIN" in
      /*) PLUGINS="$BIN";;
      *) PLUGINS="`pwd`/$BIN"
   esac
   # prepending is less flexible but safer because it ensures we find the plugins
   # in the same directory as the VM.
   if [[ -n $1 ]]; then
      LD_LIBRARY_PATH=$PLUGINS${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH} exec "$BIN/squeak" "$IMAGE" "$@"
   else
      LD_LIBRARY_PATH=$PLUGINS${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH} exec "$BIN/squeak" "$(ls Squeak*image)"
   fi
fi

